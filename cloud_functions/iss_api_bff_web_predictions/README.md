# ISS Predictions Backend-for-Frontend (Web)

This Cloud Function serves as a Backend-for-Frontend (BFF) for the web interface, specifically handling ISS location predictions. It provides both current and historical prediction data for visualization on the web app.

## Features

- Fetches current ISS location predictions from Firestore
- Retrieves historical predictions (90, 60, and 30 minutes ago)
- Aggregates predictions by method (orbital mechanics and SGP4)
- Filters predictions to only include future timestamps
- Provides CORS support for web clients
- Optimized Firestore queries for performance

## API Response Format

The API returns a JSON response containing prediction data:

```json
{
    "status": "success",
    "predictions": {
        "orbital_mechanics": [
            {
                "timestamp": "2024-01-01T12:05:00Z",
                "latitude": 48.8566,
                "longitude": 2.3522,
                "source_timestamp": "2024-01-01T12:00:00Z",
                "method": "orbital_mechanics"
            }
        ],
        "sgp4": [
            {
                "timestamp": "2024-01-01T12:05:00Z",
                "latitude": 48.8566,
                "longitude": 2.3522,
                "source_timestamp": "2024-01-01T12:00:00Z",
                "method": "sgp4"
            }
        ],
        "prediction_count": 2
    },
    "historical_predictions": {
        "predictions_90min_ago": [],
        "predictions_60min_ago": [],
        "predictions_30min_ago": []
    }
}
```

### Error Response

If an error occurs, the API returns:

```json
{
    "status": "error",
    "error": "Error message",
    "predictions": null,
    "historical_predictions": null
}
```

## Dependencies

- `flask`: Web framework for Cloud Functions
- `functions-framework`: Google Cloud Functions framework
- `google-cloud-firestore`: For accessing prediction data
- `google-cloud-secret-manager`: For API key management

## Data Source

This BFF reads from:
- Firestore collection: `iss_loc_predictions`
- Documents contain predictions generated by `iss_api_generate_predictions`

## Authentication

This function:
1. Requires API key for incoming requests (query parameter: `api_key`)
2. Uses service account for Firestore access
3. Validates API key against Secret Manager

## Performance Optimizations

- Uses Firestore query filters to reduce data transfer
- Parallel fetching of historical predictions
- Client reuse for Firestore and Secret Manager
- API key caching (5 minutes)
- Limits queries to last 24 hours of predictions

## Local Development

1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```

2. Set up authentication:
   ```bash
   export GOOGLE_APPLICATION_CREDENTIALS="path/to/service-account-key.json"
   ```

3. Run locally:
   ```bash
   functions-framework --target iss_api_bff_web_predictions --debug
   ```

4. Test the endpoint:
   ```bash
   ./test_function.sh
   ```

## Deployment

Deploy to Google Cloud Functions using:

```bash
./deploy.sh
```

## Testing

The test script verifies:
1. Authentication works correctly (API key validation)
2. CORS headers are present
3. Response format is correct
4. All required fields are present
5. Prediction data structure is valid

## Error Handling

The function provides detailed error handling for:
- Authentication failures
- Firestore query issues
- Missing prediction data
- Timeout conditions
- Invalid data formats

## Security

- Requires API key for access
- Uses service accounts for Firestore access
- Provides CORS configuration
- Sanitizes all output data
