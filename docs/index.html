<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS Sky Scanner</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Our CSS -->
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="stylesheet" href="./css/chat.css">
    <link rel="stylesheet" href="./css/message-box.css">
</head>
<body>
    <!-- Website Message Box -->
    <div id="messageBox" class="message-box-container">
        <div class="message-box-content"></div>
        <button class="message-box-close" aria-label="Close message">&times;</button>
    </div>

    <div class="container">
        <header>
            <h1>ISS Sky Scanner</h1>
            <nav class="main-nav">
                <button class="nav-tab active" id="nav-tab-map" data-view="map">Map</button>
                <button class="nav-tab" id="nav-tab-metrics" data-view="metrics">Metrics</button>
            </nav>
        </header>
        <main>
            <!-- Map View -->
            <div id="view-map" class="view-section active">
            <div class="iss-info">
                <div class="card" id="location">
                    <h2>Current Location</h2>
                    <div id="coordinates" class="data-text">Loading...</div>
                </div>
                <div class="card" id="timestamp">
                    <h2>Last Updated</h2>
                    <div id="time" class="data-text">Loading...</div>
                    <div id="time-status" class="status-message"></div>
                </div>
            </div>
            <div class="card" id="fun-fact">
                <h2>Fun Fact</h2>
                <div id="fact" class="data-text">Loading fun fact...</div>
            </div>
            <div class="card map-container">
                <div id="map"></div>
                <div id="no-data-message" class="no-data-message" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Location data is not available for this time</span>
                </div>
                <div id="path-legend" class="path-legend">
                    <h3>Path Legend</h3>
                    <div class="legend-items">
                        <div class="legend-item clickable" data-path-type="predicted" id="legend-predicted">
                            <span class="legend-color" style="background-color: #FF6B6B;"></span>
                            <span class="legend-label">Predicted Path (custom model)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card" id="history-controls">
                <h2>Location History & Predictions</h2>
                <div id="slider-loading" class="predictions-loading">
                    <div class="loading-spinner" id="slider-loading-spinner"></div>
                    <div class="loading-checkmark" id="slider-loading-checkmark" style="display: none;"></div>
                    <p id="slider-loading-text">Loading timeline...</p>
                </div>
                <div class="slider-container" id="slider-container" style="display: none;">
                    <div class="slider-range-markers">
                        <span class="range-marker left clickable" id="nav-24h-ago">-24h</span>
                        <span class="range-marker center clickable" id="nav-now">Now</span>
                        <span class="range-marker right clickable" id="nav-90m-future">+90m</span>
                    </div>
                    <input type="range" id="history-slider" min="0" value="0" class="slider">
                    <div class="slider-nav-controls">
                        <button class="nav-button nav-step-button" id="nav-step-back" aria-label="Previous step" title="Previous (5 min)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="time-skip-buttons">
                            <button class="nav-button time-skip-button" id="nav-back-1h" title="Go back 1 hour">-1h</button>
                            <button class="nav-button time-skip-button" id="nav-back-30min" title="Go back 30 minutes">-30m</button>
                            <button class="nav-button time-skip-button" id="nav-back-15min" title="Go back 15 minutes">-15m</button>
                        </div>
                        <div class="time-skip-buttons">
                            <button class="nav-button time-skip-button" id="nav-forward-15min" title="Go forward 15 minutes">+15m</button>
                            <button class="nav-button time-skip-button" id="nav-forward-30min" title="Go forward 30 minutes">+30m</button>
                            <button class="nav-button time-skip-button" id="nav-forward-1h" title="Go forward 1 hour">+1h</button>
                        </div>
                        <button class="nav-button nav-step-button" id="nav-step-forward" aria-label="Next step" title="Next (5 min)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div id="time-display" class="time-display">No history available</div>
                </div>
            </div>
            <div class="card" id="error" style="display: none;">
                <p class="error-message"></p>
            </div>
            <div class="refresh-container">
                <div class="auto-refresh-indicator">
                    <i class="fas fa-sync-alt"></i>
                    <span>Auto-refreshing every 5 minutes</span>
                </div>
            </div>
            </div>
            
            <!-- Metrics View -->
            <div id="view-metrics" class="view-section" style="display: none;">
                <div class="card">
                    <div class="graph-header">
                        <h2>Historical Location Data</h2>
                        <div class="custom-dropdown" id="graph-selector">
                            <div class="dropdown-selected" id="dropdown-selected">
                                <span class="dropdown-text">
                                    <i class="fas fa-globe graph-icon latitude-icon"></i>
                                    Latitude
                                </span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="dropdown-options" id="dropdown-options">
                                <div class="dropdown-option" data-value="latitude">
                                    <i class="fas fa-globe graph-icon latitude-icon"></i>
                                    Latitude
                                </div>
                                <div class="dropdown-option" data-value="longitude">
                                    <i class="fas fa-globe graph-icon longitude-icon"></i>
                                    Longitude
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="graph-container">
                        <div class="graph-wrapper active" id="graph-wrapper-1">
                            <canvas id="metrics-graph-1" class="graph-canvas"></canvas>
                        </div>
                        <div class="graph-wrapper" id="graph-wrapper-2">
                            <canvas id="metrics-graph-2" class="graph-canvas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card map-container">
                    <h2>Metrics Visualization Map</h2>
                    <div id="metrics-map"></div>
                    <div id="metrics-path-legend" class="path-legend">
                        <h3>Path Legend</h3>
                        <div class="legend-items">
                            <div class="legend-item clickable" data-path-type="true-historical" id="metrics-legend-true-historical">
                                <span class="legend-color" style="background-color: #FF6B6B;"></span>
                                <span class="legend-label">True Historical Path</span>
                            </div>
                            <div class="legend-item clickable" data-path-type="predicted-90min" id="metrics-legend-predicted-90min">
                                <span class="legend-color" style="background-color: #FFA500;"></span>
                                <span class="legend-label">Predicted (90 min ago)</span>
                            </div>
                            <div class="legend-item clickable" data-path-type="predicted-60min" id="metrics-legend-predicted-60min">
                                <span class="legend-color" style="background-color: #FFD700;"></span>
                                <span class="legend-label">Predicted (60 min ago)</span>
                            </div>
                            <div class="legend-item clickable" data-path-type="predicted-30min" id="metrics-legend-predicted-30min">
                                <span class="legend-color" style="background-color: #FFFF00;"></span>
                                <span class="legend-label">Predicted (30 min ago)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer>
            <p>Data provided by ISS Tracking API</p>
            <p class="credit">Created by <a href="https://github.com/FallThunder" target="_blank">Pratyush Siva</a></p>
            <p class="credit">View my <a href="https://fallthunder.github.io" target="_blank">portfolio</a></p>
            <p class="volunteer">I am actively seeking volunteer opportunities to contribute my software development skills. Feel free to reach out!</p>
        </footer>
    </div>

    <!-- Chat Widget -->
    <button id="chatButton" aria-label="Open chat" style="display: none;">
        <i class="fas fa-comments"></i>
    </button>
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <h3>ISS Location Assistant</h3>
            <button class="close-chat" id="closeChat" aria-label="Close chat">&times;</button>
        </div>
        <div class="chat-history" id="chatHistory">
            <!-- Messages will be added here dynamically -->
        </div>
        <div class="chat-input">
            <textarea id="messageInput" placeholder="Type your question..." rows="1"></textarea>
            <button id="sendMessage" aria-label="Send message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
            
    <!-- Our JavaScript -->
    <script type="module" src="./js/config.js"></script>
    <!-- issPrediction.js removed - predictions now come from API -->
    <script type="module" src="./js/main.js"></script>
    <script type="module" src="./js/metrics.js"></script>
    <script type="module" src="./js/chat.js"></script>
    <script type="module" src="./js/message.js"></script>
    <script type="module">
        import { initMetricsPage, handleMetricsViewShown } from './js/metrics.js';
        
        let metricsInitialized = false;
        
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize metrics page when metrics view is shown
            window.addEventListener('metricsViewShown', () => {
                if (!metricsInitialized) {
                    initMetricsPage();
                    metricsInitialized = true;
                }
                handleMetricsViewShown();
            });
        });
    </script>
    <script>
        // Tab navigation without page reload
        document.addEventListener('DOMContentLoaded', () => {
            const navTabs = document.querySelectorAll('.nav-tab');
            const viewSections = document.querySelectorAll('.view-section');
            
            // Check for hash in URL (for direct navigation)
            const hash = window.location.hash;
            let initialView = 'map';
            if (hash === '#metrics') {
                initialView = 'metrics';
            }
            
            // Initialize view based on URL hash or default to map
            function switchView(viewName) {
                // Update active tab
                navTabs.forEach(tab => {
                    if (tab.dataset.view === viewName) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });
                
                // Show/hide view sections
                viewSections.forEach(section => {
                    if (section.id === `view-${viewName}`) {
                        section.classList.add('active');
                        section.style.display = 'block';
                        
                        // If switching to map view, invalidate map size after a brief delay
                        // to ensure the container is visible before resizing
                        if (viewName === 'map') {
                            setTimeout(() => {
                                // Trigger a custom event that main.js can listen to
                                window.dispatchEvent(new CustomEvent('mapViewShown'));
                            }, 100);
                        }
                        
                        // If switching to metrics view, initialize metrics page
                        if (viewName === 'metrics') {
                            setTimeout(() => {
                                // Trigger a custom event that metrics.js can listen to
                                window.dispatchEvent(new CustomEvent('metricsViewShown'));
                            }, 100);
                        }
                    } else {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    }
                });
                
                // Update URL hash without reload
                if (viewName === 'map') {
                    history.replaceState(null, '', window.location.pathname);
                } else {
                    history.replaceState(null, '', `#${viewName}`);
                }
            }
            
            // Set initial view
            switchView(initialView);
            
            // Add click handlers to tabs
            navTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = tab.dataset.view;
                    switchView(viewName);
                });
            });
            
            // Handle browser back/forward buttons
            window.addEventListener('popstate', () => {
                const hash = window.location.hash;
                if (hash === '#metrics') {
                    switchView('metrics');
                } else {
                    switchView('map');
                }
            });
        });
    </script>
</body>
</html>
